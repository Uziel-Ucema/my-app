<!DOCTYPE html>
<html>
<head>
    <title>Images from Google Cloud Storage</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px 0px #ccc;
        }

        h1 {
            text-align: center;
        }

        .folder {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }

        .folder h2 {
            font-size: 24px;
        }

        .image-col {
            text-align: center;
            margin-top: 10px;
        }

        .image-col img {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .image-info p {
            margin: 5px 0;
            font-size: 16px;
        }

        /* New styles for the alert subscription section */
        .alert-subscription {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .save-changes-btn {
            margin-top: 10px;
        }

        .folder-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
        }

        .folder-list-item {
            margin-right: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Images from Google Cloud Storage</h1>

        <% if user_signed_in? %>
        <div class="alert-subscription">
            <h2>Alert Subscription</h2>
            <ul id="folderChecklist" class="folder-list"></ul>
            <button class="btn btn-primary save-changes-btn">Save Changes</button>
        </div>
        <% end %>
        <div id="imageContainer" class="row"></div>
    </div>

    <script>
        // Replace 'YOUR_BUCKET_NAME' with the actual bucket name
        const bucketName = 'primero1023';
        const apiUrl = `https://storage.googleapis.com/storage/v1/b/${bucketName}/o`;

        // Fetching folder titles
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const folderChecklist = document.getElementById('folderChecklist');

                const folderTitles = data.items.reduce((titles, item) => {
                    const pathSegments = item.name.split('/');
                    const folderName = pathSegments[0];

                    if (!titles.includes(folderName)) {
                        titles.push(folderName);
                    }

                    return titles;
                }, []);

                folderTitles.forEach(title => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('folder-list-item');

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = title;

                    const label = document.createElement('label');
                    label.htmlFor = title;
                    label.textContent = title;

                    listItem.appendChild(checkbox);
                    listItem.appendChild(label);

                    folderChecklist.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Error fetching folder data: ', error);
            });

        // Fetching image data
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const imageContainer = document.getElementById('imageContainer');

                const itemsByFolder = {};

                data.items.forEach(item => {
                    const pathSegments = item.name.split('/');
                    const folderName = pathSegments[0];

                    if (!itemsByFolder[folderName]) {
                        itemsByFolder[folderName] = [];
                    }

                    itemsByFolder[folderName].push(item);
                });

                for (const folderName in itemsByFolder) {
                    if (itemsByFolder.hasOwnProperty(folderName)) {
                        const folderSection = document.createElement('div');
                        folderSection.classList.add('folder');
                        folderSection.innerHTML = `<h2>${folderName}</h2>`;

                        const row = document.createElement('div');
                        row.classList.add('row');

                        itemsByFolder[folderName].forEach(item => {
                            if (item.contentType === 'image/jpeg') {
                                const col = document.createElement('div');
                                col.classList.add('col-md-4', 'image-col');

                                const img = document.createElement('img');
                                img.src = item.mediaLink; // The URL of the image in the bucket.
                                img.classList.add('img-fluid');
                                col.appendChild(img);

                                const imageInfo = document.createElement('div');
                                imageInfo.classList.add('image-info');
                                
                                const name = document.createElement('p');
                                name.innerText = 'Image Name: ' + item.name;
                                imageInfo.appendChild(name);

                                const date = document.createElement('p');
                                date.innerText = 'Submitted Date: ' + new Date(item.timeCreated).toDateString();
                                imageInfo.appendChild(date);

                                col.appendChild(imageInfo);

                                row.appendChild(col);
                            }
                        });

                        folderSection.appendChild(row);
                        imageContainer.appendChild(folderSection);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching image data: ', error);
            });
    </script>
</body>
</html>
